{{- if .Values.om.persistence.enabled }}
{{- $dnodes := ternary (splitList "," (include "ozone.om.decommissioned.nodes" .)) (list) (ne "" (include "ozone.om.decommissioned.nodes" .)) }}
{{- if (gt (len $dnodes) 0) }}
{{- range $dnode := $dnodes }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ printf "%s-helm-manager-decommission-%s-svc" $.Release.Name $dnode }}
  labels:
    {{- include "ozone.labels" $ | nindent 4 }}
    app.kubernetes.io/component: helm-manager
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": hook-succeeded, hook-failed
spec:
  selector:
    job-name: {{ printf "%s-helm-manager-decommission-%s" $.Release.Name $dnode }}
  ports:
    - name: rpc
      port: {{ $.Values.om.service.rpcPort }}
      targetPort: {{ $.Values.om.service.rpcPort }}
    - name: ratis
      port: {{ $.Values.om.service.ratisPort }}
      targetPort: {{ $.Values.om.service.ratisPort }}
  type: ClusterIP
{{- end }}
{{- end }}
{{- end }}